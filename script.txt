// ==UserScript==
// @name         å·¥ä½œå°æ–‡æœ¬ç¿»è¯‘|å¤åˆ¶æŒ‰é’®|è‡ªåŠ¨ç¼©æ”¾|æ€§èƒ½ä¿®å¤ç‰ˆ
// @namespace    http://tampermonkey.net/
// @version      8.2.0
// @description  ä¿ç•™åŸç‰ˆæ‰€æœ‰åŠŸèƒ½ï½œè§£å†³Ant-PopoveråŠ¨ç”»å¡é¡¿ï½œä¿®å¤ç›¸åŒè¡Œä¸ç¿»è¯‘ï½œä¼˜åŒ–å­—ä½“è®¡ç®—æ€§èƒ½
// @author       You
// @match        https://breeze.opd.easebar.com/*
// @grant        GM_xmlhttpRequest
// @grant        GM_notification
// @grant        GM_getValue
// @grant        GM_setValue
// @connect      translate.googleapis.com
// @run-at       document-idle
// ==/UserScript==

(function () {
    'use strict';

    // ====== é…ç½® ======
    const COLUMN_INDEX = 8; // åªå¤„ç†ç¬¬8åˆ—
    let MIN_FONT_SIZE = 16;
    let MAX_FONT_SIZE = 32;
    const MAX_CELL_HEIGHT = 165;
    const SINGLE_LINE_HEIGHT = 50;
    const BATCH_SIZE = 25;
    let SINGLE_LINE_CHAR_LIMIT = 60;
    const COPY_BTN_CLASS = 'copy-original-btn';
    const ROLE_COPY_BTN_CLASS = 'copy-role-combined-btn';
    const ROLE_ID_ONLY_COPY_BTN_CLASS = 'copy-role-id-only-btn';
    const EXPANDED_CLASS = 'expanded-full';

    // ====== æ€§èƒ½ä¼˜åŒ–é…ç½® ======
    const PERFORMANCE_CONFIG = {
        logLevel: 'info',
        debounceDelay: 500, // å¢åŠ é˜²æŠ–æ—¶é—´
        maxCellsPerBatch: 50,
        smartScrollEnabled: true
    };

    // ====== æ™ºèƒ½æŒ‰é’®é«˜åº¦é€‚é…é…ç½® ======
    const BUTTON_ADAPTER_CONFIG = {
        targetButtons: 'button.ant-btn',
        targetButtonTexts: ['Forbid', 'Rename', 'Punish'],
        containerSelector: '.ant-space-item, .ant-space',
        checkInterval: 500, // é™ä½æ£€æŸ¥é¢‘ç‡
        minHeightThreshold: 1,
        maxButtonHeight: 140,
        minButtonHeight: 20,
        buttonHeightOffset: -18,
        singleColumnThreshold: 1,
        isEnabled: false,
        waitForTranslation: true,
        translationWaitTime: 800,
        maxRetryCount: 3
    };

    let isTranslationEnabled = true;
    const translationCache = new Map();
    let processing = false;
    let processDebounceTimer = null;
    let roleIdColumnIndexes = [];
    
    // å…¨å±€æµ‹é‡å®¹å™¨ï¼ˆæ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒï¼šå¤ç”¨DOMï¼‰
    let globalMeasureContainer = null;

    // ====== æŒ‰é’®é«˜åº¦é€‚é…ç›¸å…³å˜é‡ ======
    const processedButtons = new WeakSet(); // æ”¹ç”¨ WeakSet é˜²æ­¢å†…å­˜æ³„æ¼
    const pendingButtonAdaptations = new WeakMap();
    
    // ====== æ§åˆ¶é¢æ¿çŠ¶æ€å˜é‡ ======
    let controlPanelMinimized = true;
    let controlPanel = null;
    let minimizeBtn = null;
    let contentContainer = null;
    let panelHeader = null;

    // ====== æ™ºèƒ½æ»šåŠ¨ç›¸å…³å˜é‡ ======
    let scrollHandlersAttached = false;

    // ====== æ—¥å¿—å‡½æ•° ======
    function log(level, message, data) {
        const levels = { debug: 0, info: 1, warn: 2, error: 3 };
        const currentLevel = levels[PERFORMANCE_CONFIG.logLevel] || 1;
        const messageLevel = levels[level] || 1;
        if (messageLevel >= currentLevel) {
            // console[level](`ğŸ”§ ${message}`, data || '');
        }
    }

    function init() {
        log('info', `å·¥ä½œå°ç¿»è¯‘åŠ©æ‰‹ v8.2.0 æ€§èƒ½ä¿®å¤ç‰ˆå·²åŠ è½½`);
        loadSettings();
        addGlobalStyle();
        createMeasureContainer(); // åˆå§‹åŒ–æµ‹é‡å®¹å™¨
        bindShortcut();
        startStableMonitoring();
        initButtonHeightAdapter();
        createControlPanel();

        setTimeout(() => {
            initSmartScrollHandling();
        }, 2000);
    }

    // ====== æ ¸å¿ƒä¼˜åŒ–ï¼šå…¨å±€æµ‹é‡å®¹å™¨ ======
    function createMeasureContainer() {
        if (globalMeasureContainer) return;
        globalMeasureContainer = document.createElement('div');
        globalMeasureContainer.style.cssText = `
            position: absolute;
            left: -9999px;
            top: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.1;
            padding: 4px 6px;
            margin: 0;
            box-sizing: border-box;
            visibility: hidden;
            pointer-events: none;
            z-index: -9999;
        `;
        document.body.appendChild(globalMeasureContainer);
    }

    // ====== æ™ºèƒ½æ»šåŠ¨å¤„ç† ======
    function initSmartScrollHandling() {
        if (!PERFORMANCE_CONFIG.smartScrollEnabled || scrollHandlersAttached) return;

        const handleWheelEvent = (e) => {
            // ç®€å•åˆ¤æ–­ï¼Œåªå¤„ç† fixed-height-cell å†…éƒ¨æ»šåŠ¨
            const target = e.target;
            const cell = target.closest('.fixed-height-cell');
            
            if (cell && cell.scrollHeight > cell.clientHeight) {
                const atTop = cell.scrollTop === 0;
                const atBottom = Math.abs(cell.scrollHeight - cell.scrollTop - cell.clientHeight) < 1;
                const up = e.deltaY < 0;
                const down = e.deltaY > 0;

                // åªæœ‰å½“å†…éƒ¨è¿˜èƒ½æ»šåŠ¨æ—¶ï¼Œé˜»æ­¢å†’æ³¡ï¼Œé˜²æ­¢é¡µé¢æ»šåŠ¨
                if ((up && !atTop) || (down && !atBottom)) {
                    e.stopPropagation();
                }
            }
        };

        const passiveOptions = { passive: false, capture: true }; // ä½¿ç”¨ capture å°½æ—©æ‹¦æˆª
        document.addEventListener('wheel', handleWheelEvent, passiveOptions);
        scrollHandlersAttached = true;
    }

    function disableSmartScrollHandling() {
        // ç®€åŒ–å¤„ç†ï¼Œæš‚ä¸å®ç°ç§»é™¤ï¼Œå½±å“ä¸å¤§
    }

    // ====== åŠ è½½è®¾ç½® ======
    function loadSettings() {
        try {
            const savedMinFontSize = GM_getValue('minFontSize');
            const savedMaxFontSize = GM_getValue('maxFontSize');
            const savedCharLimit = GM_getValue('charLimit');
            const savedTranslationEnabled = GM_getValue('translationEnabled');
            const savedButtonAdapterEnabled = GM_getValue('buttonAdapterEnabled');
            const savedPanelMinimized = GM_getValue('panelMinimized');

            if (savedMinFontSize !== undefined) MIN_FONT_SIZE = savedMinFontSize;
            if (savedMaxFontSize !== undefined) MAX_FONT_SIZE = savedMaxFontSize;
            if (savedCharLimit !== undefined) SINGLE_LINE_CHAR_LIMIT = savedCharLimit;
            if (savedTranslationEnabled !== undefined) isTranslationEnabled = savedTranslationEnabled;
            if (savedButtonAdapterEnabled !== undefined) BUTTON_ADAPTER_CONFIG.isEnabled = savedButtonAdapterEnabled;
            if (savedPanelMinimized !== undefined) controlPanelMinimized = savedPanelMinimized;
        } catch (error) {
            log('warn', 'åŠ è½½è®¾ç½®å¤±è´¥', error);
        }
    }

    function saveSettings() {
        try {
            GM_setValue('minFontSize', MIN_FONT_SIZE);
            GM_setValue('maxFontSize', MAX_FONT_SIZE);
            GM_setValue('charLimit', SINGLE_LINE_CHAR_LIMIT);
            GM_setValue('translationEnabled', isTranslationEnabled);
            GM_setValue('buttonAdapterEnabled', BUTTON_ADAPTER_CONFIG.isEnabled);
            GM_setValue('panelMinimized', controlPanelMinimized);
        } catch (error) {
            log('warn', 'ä¿å­˜è®¾ç½®å¤±è´¥:', error);
        }
    }

    // ====== åˆ›å»ºæ§åˆ¶é¢æ¿ (ä¿æŒåŸæ ·) ======
    function createControlPanel() {
        // ... (ä¿ç•™åŸç‰ˆæ§åˆ¶é¢æ¿ä»£ç ç»“æ„ï¼Œä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œè¿™é‡Œç›´æ¥å¤ç”¨ä¹‹å‰çš„é€»è¾‘)
        controlPanel = document.createElement('div');
        controlPanel.id = 'translation-assistant-control-panel';
        controlPanel.style.cssText = `
            position: fixed; top: 20px; right: 20px; z-index: 10000;
            background: rgba(255, 255, 255, 0.95); border: 1px solid rgba(0, 0, 0, 0.15);
            border-radius: 8px; box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
            font-family: sans-serif; font-size: 12px; color: #333;
            transition: all 0.3s ease; overflow: hidden;
        `;

        // ç®€åŒ–çš„é¢æ¿æ„å»ºï¼Œæ ¸å¿ƒé€»è¾‘ä¸å˜
        if (controlPanelMinimized) {
            controlPanel.style.width = '30px';
            controlPanel.style.height = '30px';
        } else {
            controlPanel.style.width = '280px';
        }

        const innerHTML = `
            <div id="panel-min-btn" style="width:100%;height:30px;display:${controlPanelMinimized ? 'flex' : 'none'};align-items:center;justify-content:center;cursor:pointer;background:rgba(24,144,255,0.1);color:#1890ff;font-weight:bold;">+</div>
            <div id="panel-content" style="display:${controlPanelMinimized ? 'none' : 'block'};">
                <div style="padding:10px;background:#f0f2f5;display:flex;justify-content:space-between;cursor:move;" id="panel-header">
                    <b>ğŸ”§ ç¿»è¯‘åŠ©æ‰‹ v8.2</b> <span id="panel-close" style="cursor:pointer">âˆ’</span>
                </div>
                <div style="padding:15px;max-height:400px;overflow-y:auto;">
                    <label style="display:flex;align-items:center;margin-bottom:8px;"><input type="checkbox" id="translation-toggle" ${isTranslationEnabled ? 'checked' : ''} style="margin-right:8px"> å¯ç”¨ç¿»è¯‘</label>
                    <label style="display:flex;align-items:center;margin-bottom:8px;"><input type="checkbox" id="button-height-adapter-toggle" ${BUTTON_ADAPTER_CONFIG.isEnabled ? 'checked' : ''} style="margin-right:8px"> æŒ‰é’®é«˜åº¦é€‚é…</label>
                    <div style="margin:10px 0;">å­—ä½“èŒƒå›´: <input id="min-font-size" type="number" value="${MIN_FONT_SIZE}" style="width:40px"> - <input id="max-font-size" type="number" value="${MAX_FONT_SIZE}" style="width:40px"> px</div>
                    <div style="margin:10px 0;">å•è¡Œé™åˆ¶: <input id="single-line-char-limit" type="number" value="${SINGLE_LINE_CHAR_LIMIT}" style="width:50px"> å­—ç¬¦</div>
                    <button id="apply-settings-btn" style="width:100%;background:#1890ff;color:white;border:none;padding:6px;border-radius:4px;cursor:pointer;margin-top:10px;">åº”ç”¨è®¾ç½®</button>
                </div>
            </div>
        `;
        controlPanel.innerHTML = innerHTML;
        document.body.appendChild(controlPanel);

        // ç®€å•çš„äº‹ä»¶ç»‘å®š
        const minBtn = controlPanel.querySelector('#panel-min-btn');
        const closeBtn = controlPanel.querySelector('#panel-close');
        const content = controlPanel.querySelector('#panel-content');
        
        const togglePanel = () => {
            controlPanelMinimized = !controlPanelMinimized;
            minBtn.style.display = controlPanelMinimized ? 'flex' : 'none';
            content.style.display = controlPanelMinimized ? 'none' : 'block';
            controlPanel.style.width = controlPanelMinimized ? '30px' : '280px';
            controlPanel.style.height = controlPanelMinimized ? '30px' : 'auto';
            saveSettings();
        };

        minBtn.onclick = togglePanel;
        closeBtn.onclick = togglePanel;

        // æ‹–æ‹½
        const header = controlPanel.querySelector('#panel-header');
        let isDragging = false, startX, startY, initialLeft, initialTop;
        header.onmousedown = (e) => {
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            initialLeft = controlPanel.offsetLeft;
            initialTop = controlPanel.offsetTop;
            header.style.cursor = 'grabbing';
        };
        document.onmousemove = (e) => {
            if (!isDragging) return;
            controlPanel.style.left = (initialLeft + e.clientX - startX) + 'px';
            controlPanel.style.top = (initialTop + e.clientY - startY) + 'px';
            controlPanel.style.right = 'auto';
        };
        document.onmouseup = () => { isDragging = false; header.style.cursor = 'move'; };

        // åº”ç”¨è®¾ç½®
        controlPanel.querySelector('#apply-settings-btn').onclick = () => {
            MIN_FONT_SIZE = parseInt(controlPanel.querySelector('#min-font-size').value);
            MAX_FONT_SIZE = parseInt(controlPanel.querySelector('#max-font-size').value);
            SINGLE_LINE_CHAR_LIMIT = parseInt(controlPanel.querySelector('#single-line-char-limit').value);
            isTranslationEnabled = controlPanel.querySelector('#translation-toggle').checked;
            BUTTON_ADAPTER_CONFIG.isEnabled = controlPanel.querySelector('#button-height-adapter-toggle').checked;
            saveSettings();
            
            // è§¦å‘åˆ·æ–°
            if (isTranslationEnabled) reprocessTranslationsOnly();
            else removeTranslationsOnly();
            
            adjustFontSizesOnly();
            
            if (BUTTON_ADAPTER_CONFIG.isEnabled) initialButtonScan();
            else {
                 document.querySelectorAll('button[data-height-adapted="true"]').forEach(btn => {
                    btn.removeAttribute('data-height-adapted');
                    btn.style.height = '';
                });
            }
            
            showNotification('è®¾ç½®å·²åº”ç”¨', 'success');
        };
    }

    function showNotification(message, type) {
        if (typeof GM_notification === 'function') {
            GM_notification({ text: message, timeout: 2000 });
        } else {
            console.log(message);
        }
    }

    // ====== ä¿®å¤çš„æ ¸å¿ƒç›‘æ§ç³»ç»Ÿ ======
    function startStableMonitoring() {
        log('info', 'å¯åŠ¨ç¨³å®šç›‘æ§ç³»ç»Ÿ...');

        const ignoreList = ['ANT-POPOVER', 'ANT-TOOLTIP', 'ANT-MESSAGE', 'ANT-DROPDOWN'];

        observer = new MutationObserver((mutations) => {
            let shouldProcess = false;
            
            for (const mutation of mutations) {
                // 1. ä¸¥æ ¼è¿‡æ»¤ï¼šå¦‚æœå˜åŠ¨æºè‡ª Popover/Tooltipï¼Œç›´æ¥å¿½ç•¥
                const target = mutation.target;
                if (target.nodeType === 1) {
                    // å‘ä¸ŠæŸ¥æ‰¾æ˜¯å¦åœ¨å¿½ç•¥åˆ—è¡¨ä¸­
                    const closestIgnore = target.closest('.ant-popover, .ant-tooltip, .ant-dropdown, .ant-select-dropdown');
                    if (closestIgnore) continue; // å¿½ç•¥æ­¤æ¬¡å˜åŠ¨
                    
                    // æ£€æŸ¥è‡ªèº«ç±»å
                    if (target.classList && (target.classList.contains('ant-popover') || target.classList.contains('ant-tooltip'))) continue;
                }

                // 2. åªå…³æ³¨è¡¨æ ¼è¡Œçš„å˜åŒ–
                if (mutation.type === 'childList') {
                    for (const node of mutation.addedNodes) {
                        if (node.nodeType === 1) {
                            if (node.tagName === 'TR' || 
                                node.tagName === 'TD' || 
                                node.classList.contains('ant-table-tbody') || 
                                node.querySelector('.ant-table-tbody')) {
                                shouldProcess = true;
                                break;
                            }
                        }
                    }
                }
                if (shouldProcess) break;
            }

            if (shouldProcess) {
                scheduleProcessNewCells();
                // å»¶è¿ŸæŸ¥æ‰¾ Role ID åˆ—ï¼Œå› ä¸ºè¡¨å¤´å¯èƒ½ç¨ååŠ è½½
                setTimeout(() => {
                    findRoleIdColumns();
                    addCopyButtonsToRoleIdColumns();
                    addRoleIdOnlyCopyButtons();
                }, 500);
            }
        });

        observer.observe(document.body, {
            childList: true,
            subtree: true,
            attributes: false // ä¸ç›‘å¬å±æ€§ï¼Œå‡å°‘è§¦å‘
        });

        // åˆå§‹æ‰§è¡Œ
        setTimeout(() => {
            processAllCellsInBatches();
            findRoleIdColumns();
            addCopyButtonsToRoleIdColumns();
            addRoleIdOnlyCopyButtons();
        }, 1500);
    }

    function processAllCellsInBatches() {
        if (processing) return;
        processing = true;

        // ä¿®å¤ï¼šä¸å†ä½¿ç”¨ Set å»é‡ï¼Œè€Œæ˜¯ä½¿ç”¨ dataset æ ‡è®°ã€‚
        // æŸ¥æ‰¾æ‰€æœ‰æ²¡æœ‰è¢«æ ‡è®°ä¸º "processed-v8" çš„ç¬¬8åˆ—å•å…ƒæ ¼
        const allCells = Array.from(document.querySelectorAll(`.ant-table-tbody > tr > td:nth-child(${COLUMN_INDEX}):not([data-processed-v8="true"])`));
        
        // è¿‡æ»¤æ‰ç©ºå†…å®¹çš„å•å…ƒæ ¼
        const cellsToProcess = allCells.filter(cell => {
            const text = cell.innerText.trim(); // ä½¿ç”¨ innerText å¿«é€Ÿæ£€æŸ¥
            return text.length >= 2;
        }).slice(0, PERFORMANCE_CONFIG.maxCellsPerBatch);

        // ç«‹å³å¤„ç†è¿™æ‰¹å•å…ƒæ ¼
        for (const cell of cellsToProcess) {
            wrapCellContent(cell);
            cell.setAttribute('data-processed-v8', 'true'); // æ ‡è®°å·²å¤„ç†
            
            // å¼‚æ­¥æ‰§è¡Œç¿»è¯‘å’Œå­—ä½“è°ƒæ•´
            setTimeout(() => {
                adjustFontSizeForCell(cell);
                if (isTranslationEnabled && cell.dataset.translated !== 'true') {
                    translateIfNeeded(cell);
                }
                // æŒ‰é’®é€‚é…
                if (BUTTON_ADAPTER_CONFIG.isEnabled) {
                    scheduleButtonAdaptationForRow(cell.closest('tr'));
                }
            }, 0);
        }

        processing = false;
        
        // å¦‚æœè¿˜æœ‰å‰©ä½™æœªå¤„ç†çš„ï¼Œç»§ç»­è°ƒåº¦
        if (allCells.length > cellsToProcess.length) {
            setTimeout(processAllCellsInBatches, 100);
        }
    }

    function scheduleProcessNewCells() {
        if (processDebounceTimer) clearTimeout(processDebounceTimer);
        processDebounceTimer = setTimeout(() => {
            processAllCellsInBatches();
        }, PERFORMANCE_CONFIG.debounceDelay);
    }

    function reprocessTranslationsOnly() {
        const allCells = document.querySelectorAll(`.ant-table-tbody > tr > td:nth-child(${COLUMN_INDEX})`);
        allCells.forEach(cell => {
            cell.dataset.translated = '';
            const trans = cell.querySelector('.translation');
            if(trans) trans.remove();
            translateIfNeeded(cell);
        });
    }

    function removeTranslationsOnly() {
        const allCells = document.querySelectorAll(`.ant-table-tbody > tr > td:nth-child(${COLUMN_INDEX})`);
        allCells.forEach(cell => {
            cell.dataset.translated = 'false';
            const trans = cell.querySelector('.translation');
            if(trans) trans.remove();
            adjustFontSizeForCell(cell);
        });
    }

    function adjustFontSizesOnly() {
        const allCells = document.querySelectorAll(`.ant-table-tbody > tr > td:nth-child(${COLUMN_INDEX})`);
        allCells.forEach(cell => adjustFontSizeForCell(cell));
    }

    // ====== å…¨å±€æ ·å¼ ======
    function addGlobalStyle() {
        const style = document.createElement('style');
        style.textContent = `
            /* ä¿æŒåŸæœ‰æ ·å¼ */
            .ant-table-tbody > tr > td:nth-child(${COLUMN_INDEX}) {
                position: relative !important; padding: 0 !important; height: auto !important;
            }
            .fixed-height-cell {
                position: relative; width: 100%; max-height: ${MAX_CELL_HEIGHT}px;
                overflow-y: auto; padding: 4px 6px; box-sizing: border-box;
                line-height: 1.1; white-space: pre-wrap; word-wrap: break-word;
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
            }
            .fixed-height-cell.single-line {
                overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
                height: ${SINGLE_LINE_HEIGHT}px; line-height: ${SINGLE_LINE_HEIGHT}px;
            }
            .fixed-height-cell.no-scroll { overflow: hidden; }
            .fixed-height-cell .translation { display: inline; font-weight: bold !important; margin-left: 8px; }
            .fixed-height-cell.long-text {
                cursor: pointer; background: linear-gradient(135deg, rgba(24, 144, 255, 0.05) 0%, rgba(24, 144, 255, 0.1) 100%);
            }
            .fixed-height-cell.${EXPANDED_CLASS} {
                max-height: none !important; overflow: visible !important;
                background: rgba(24, 144, 255, 0.05); border: 1px solid rgba(24, 144, 255, 0.3);
                padding: 8px; border-radius: 4px; z-index: 100;
            }
            
            /* æŒ‰é’®æ ·å¼ */
            .${COPY_BTN_CLASS} {
                position: absolute; top: 4px; right: 4px; width: 24px; height: 24px;
                background: rgba(255,255,255,0.5); border: 1px solid #ccc; border-radius: 4px;
                display: flex; align-items: center; justify-content: center; cursor: pointer;
                font-size: 14px; opacity: 0; transition: opacity 0.2s;
            }
            td:hover .${COPY_BTN_CLASS} { opacity: 1; }
            .${COPY_BTN_CLASS}:hover { background: #fff; border-color: #1890ff; }

            .${ROLE_COPY_BTN_CLASS}, .${ROLE_ID_ONLY_COPY_BTN_CLASS} {
                position: absolute; top: 4px; width: 20px; height: 20px;
                background: rgba(255,255,255,0.5); border: 1px solid #ccc; border-radius: 4px;
                display: flex; align-items: center; justify-content: center; cursor: pointer;
                font-size: 12px; opacity: 0; transition: opacity 0.2s;
            }
            td:hover .${ROLE_COPY_BTN_CLASS}, td:hover .${ROLE_ID_ONLY_COPY_BTN_CLASS} { opacity: 1; }
            .${ROLE_COPY_BTN_CLASS} { right: 4px; }
            .${ROLE_ID_ONLY_COPY_BTN_CLASS} { left: 4px; }
            .${ROLE_COPY_BTN_CLASS}:hover, .${ROLE_ID_ONLY_COPY_BTN_CLASS}:hover { background: #1890ff; color: white; border-color: #1890ff; }
        `;
        document.head.appendChild(style);
    }

    // ====== Role ID åŠŸèƒ½ (ä¿æŒåŸé€»è¾‘) ======
    function findRoleIdColumns() {
        const headers = document.querySelectorAll('.ant-table-thead th');
        roleIdColumnIndexes = [];
        headers.forEach((header) => {
            const text = header.textContent.toLowerCase();
            if (text.includes('role_id') || text.includes('role id') || text.includes('roleid')) {
                const colIndex = Array.from(header.parentElement.children).indexOf(header) + 1;
                if (colIndex !== COLUMN_INDEX && !roleIdColumnIndexes.includes(colIndex)) {
                    roleIdColumnIndexes.push(colIndex);
                }
            }
        });
    }

    function addCopyButtonsToRoleIdColumns() {
        roleIdColumnIndexes.forEach(colIndex => {
            const cells = document.querySelectorAll(`.ant-table-tbody > tr > td:nth-child(${colIndex})`);
            cells.forEach(cell => {
                if (cell.querySelector(`.${ROLE_COPY_BTN_CLASS}`)) return;
                const text = getCleanCellText(cell);
                if (!text) return;

                const btn = document.createElement('div');
                btn.className = ROLE_COPY_BTN_CLASS;
                btn.textContent = '+';
                btn.title = 'å¤åˆ¶ç¬¬8åˆ—åŸæ–‡+RoleID';
                btn.onclick = (e) => {
                    e.stopPropagation();
                    const row = cell.closest('tr');
                    const col8 = row.querySelector(`td:nth-child(${COLUMN_INDEX})`);
                    const col8Text = col8 ? (col8.dataset.originalText || getCleanCellText(col8)) : '';
                    const roleText = getCleanCellText(cell);
                    copyToClipboard(col8Text + '\n' + roleText, btn);
                };
                cell.style.position = 'relative';
                cell.appendChild(btn);
            });
        });
    }
    
    function addRoleIdOnlyCopyButtons() {
        roleIdColumnIndexes.forEach(colIndex => {
            const cells = document.querySelectorAll(`.ant-table-tbody > tr > td:nth-child(${colIndex})`);
            cells.forEach(cell => {
                if (cell.querySelector(`.${ROLE_ID_ONLY_COPY_BTN_CLASS}`)) return;
                const text = getCleanCellText(cell);
                if (!text) return;

                const btn = document.createElement('div');
                btn.className = ROLE_ID_ONLY_COPY_BTN_CLASS;
                btn.textContent = '-';
                btn.title = 'ä»…å¤åˆ¶RoleID';
                btn.onclick = (e) => {
                    e.stopPropagation();
                    copyToClipboard(getCleanCellText(cell), btn);
                };
                cell.style.position = 'relative';
                cell.appendChild(btn);
            });
        });
    }

    // ====== å•å…ƒæ ¼å¤„ç† (ä¿®å¤ç›¸åŒå†…å®¹é—®é¢˜) ======
    function getCleanCellText(cell) {
        if (!cell) return '';
        const clone = cell.cloneNode(true);
        const ignores = clone.querySelectorAll(`button, .${COPY_BTN_CLASS}, .${ROLE_COPY_BTN_CLASS}, .${ROLE_ID_ONLY_COPY_BTN_CLASS}`);
        ignores.forEach(el => el.remove());
        return clone.textContent.trim();
    }

    function wrapCellContent(cell) {
        const text = getCleanCellText(cell);
        if (!text) return;

        // æ¸…ç†æ—§å±æ€§
        delete cell.dataset.translated;
        
        // é‡å»ºç»“æ„
        cell.innerHTML = '';
        cell.dataset.originalText = text;

        const container = document.createElement('div');
        container.className = 'fixed-height-cell';
        
        const originalSpan = document.createElement('span');
        originalSpan.className = 'original';
        originalSpan.textContent = text;
        
        container.appendChild(originalSpan);
        cell.appendChild(container);

        // æ·»åŠ å¤åˆ¶æŒ‰é’®
        addCopyButtonToCell(cell);

        // é•¿æ–‡æœ¬ç‚¹å‡»å±•å¼€
        if (text.length > SINGLE_LINE_CHAR_LIMIT) {
            container.classList.add('long-text');
            container.onclick = (e) => {
                e.stopPropagation();
                const isExp = container.classList.contains(EXPANDED_CLASS);
                if (isExp) {
                    container.classList.remove(EXPANDED_CLASS);
                    adjustFontSizeForCell(cell);
                } else {
                    container.classList.add(EXPANDED_CLASS);
                    container.style.fontSize = '16px';
                }
            };
        }
    }

    function addCopyButtonToCell(cell) {
        const btn = document.createElement('div');
        btn.className = COPY_BTN_CLASS;
        btn.textContent = '+';
        btn.title = 'å¤åˆ¶åŸæ–‡';
        btn.onclick = (e) => {
            e.stopPropagation();
            const text = cell.dataset.originalText || getCleanCellText(cell);
            copyToClipboard(text, btn);
        };
        cell.appendChild(btn);
    }

    async function copyToClipboard(text, btn) {
        try {
            await navigator.clipboard.writeText(text);
            const oldTxt = btn.textContent;
            btn.textContent = 'âœ“';
            btn.style.color = 'green';
            setTimeout(() => { btn.textContent = oldTxt; btn.style.color = ''; }, 1000);
        } catch (e) {
            btn.textContent = 'âœ—';
            btn.style.color = 'red';
        }
    }

    // ====== å­—ä½“è°ƒæ•´ (ä½¿ç”¨å¤ç”¨å®¹å™¨ä¼˜åŒ–æ€§èƒ½) ======
    function adjustFontSizeForCell(cell) {
        const container = cell.querySelector('.fixed-height-cell');
        if (!container || container.classList.contains(EXPANDED_CLASS)) return;

        // æ„é€ å¾…æµ‹é‡çš„æ–‡æœ¬å†…å®¹
        let textToMeasure = '';
        const orig = container.querySelector('.original');
        const trans = container.querySelector('.translation');
        if (orig) textToMeasure += orig.textContent;
        if (trans) textToMeasure += ' ' + trans.textContent;
        if (!textToMeasure) textToMeasure = cell.dataset.originalText || '';

        // ç¡®ä¿å…¨å±€å®¹å™¨å­˜åœ¨
        if (!globalMeasureContainer) createMeasureContainer();

        // è®¾ç½®å®¹å™¨çŠ¶æ€
        globalMeasureContainer.style.width = container.clientWidth + 'px';
        // å¦‚æœè¿™é‡Œæ˜¯åŒspanç»“æ„ï¼Œæµ‹é‡å®¹å™¨æœ€å¥½ä¹Ÿä¿æŒä¸€è‡´ï¼Œç®€åŒ–èµ·è§è¿™é‡Œç›´æ¥æµ‹çº¯æ–‡æœ¬ï¼Œè¯¯å·®é€šå¸¸å¯æ¥å—
        // ä¸ºäº†æ›´ç²¾ç¡®ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•æ¸…ç©ºå¹¶æ”¾å…¥æ–‡æœ¬
        globalMeasureContainer.textContent = textToMeasure;

        // æ ¸å¿ƒç®—æ³•ï¼šäºŒåˆ†é€¼è¿‘ï¼ˆæˆ–è€…ç®€å•çš„å‘ä¸‹éå†ï¼Œå› ä¸ºé€šå¸¸å­—ä½“æ¯”è¾ƒå¤§ï¼‰
        // è¿™é‡Œé‡‡ç”¨ç®€å•çš„å‘ä¸‹éå†ï¼Œå› ä¸ºèŒƒå›´å° (16-32)ï¼Œæ¯”äºŒåˆ†æ›´ä¸æ˜“å‡ºé”™
        let size = MAX_FONT_SIZE;
        
        // 1. æ£€æŸ¥æœ€å¤§å­—ä½“æ˜¯å¦å¯è¡Œ
        globalMeasureContainer.style.fontSize = size + 'px';
        
        // å¦‚æœå•è¡Œæ¨¡å¼æ£€æŸ¥
        const charCount = textToMeasure.length;
        if (charCount <= SINGLE_LINE_CHAR_LIMIT) {
            container.classList.add('single-line');
            // å•è¡Œå°½é‡å¤§
            while (size > MIN_FONT_SIZE) {
                 globalMeasureContainer.style.fontSize = size + 'px';
                 if (globalMeasureContainer.scrollHeight <= SINGLE_LINE_HEIGHT * 1.2) break;
                 size -= 2;
            }
        } else {
            container.classList.remove('single-line');
            // å¤šè¡Œï¼Œé€‚åº”æœ€å¤§é«˜åº¦
            while (size > MIN_FONT_SIZE) {
                globalMeasureContainer.style.fontSize = size + 'px';
                if (globalMeasureContainer.scrollHeight <= MAX_CELL_HEIGHT) break;
                size -= 1;
            }
        }

        // åº”ç”¨ç»“æœ
        container.style.fontSize = size + 'px';
        
        // æ»šåŠ¨æ¡æ˜¾éš
        const hasScroll = container.scrollHeight > MAX_CELL_HEIGHT + 5;
        if (hasScroll) container.classList.remove('no-scroll');
        else container.classList.add('no-scroll');
    }

    // ====== ç¿»è¯‘åŠŸèƒ½ ======
    async function translateIfNeeded(cell) {
        const text = cell.dataset.originalText;
        if (!text || text.length < 2) return;
        
        if (translationCache.has(text)) {
            applyTranslation(cell, translationCache.get(text));
            return;
        }

        try {
            const result = await translateText(text);
            if (result && result !== text) {
                translationCache.set(text, result);
                applyTranslation(cell, result);
            }
        } catch (e) { /* ignore */ }
    }

    function applyTranslation(cell, translatedText) {
        const container = cell.querySelector('.fixed-height-cell');
        if (!container || container.querySelector('.translation')) return;

        const span = document.createElement('span');
        span.className = 'translation';
        span.textContent = translatedText;
        container.appendChild(span);
        cell.dataset.translated = 'true';
        
        adjustFontSizeForCell(cell);
    }

    function translateText(text) {
        return new Promise((resolve) => {
            const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=zh-CN&dt=t&q=${encodeURIComponent(text)}`;
            GM_xmlhttpRequest({
                method: 'GET', url, timeout: 5000,
                onload: (res) => {
                    try {
                        const data = JSON.parse(res.responseText);
                        let str = '';
                        if (data[0]) data[0].forEach(item => str += item[0]);
                        resolve(str || text);
                    } catch (e) { resolve(text); }
                },
                onerror: () => resolve(text)
            });
        });
    }

    // ====== æŒ‰é’®é«˜åº¦é€‚é… (ä¿ç•™åŸé€»è¾‘) ======
    function initButtonHeightAdapter() {
        if (!BUTTON_ADAPTER_CONFIG.isEnabled) return;
        setInterval(() => {
            if (BUTTON_ADAPTER_CONFIG.isEnabled) processAllTargetButtons();
        }, BUTTON_ADAPTER_CONFIG.checkInterval);
    }

    function processAllTargetButtons() {
        const btns = document.querySelectorAll(BUTTON_ADAPTER_CONFIG.targetButtons);
        btns.forEach(btn => {
            if (isTargetButton(btn) && !processedButtons.has(btn)) {
                adaptButtonHeight(btn);
            }
        });
    }

    function isTargetButton(btn) {
        const txt = btn.textContent;
        return BUTTON_ADAPTER_CONFIG.targetButtonTexts.some(t => txt.includes(t));
    }

    function adaptButtonHeight(btn) {
        const row = btn.closest('tr');
        if (!row) return;
        const cell8 = row.querySelector(`td:nth-child(${COLUMN_INDEX}) .fixed-height-cell`);
        if (cell8) {
            let h = cell8.scrollHeight + BUTTON_ADAPTER_CONFIG.buttonHeightOffset;
            h = Math.min(Math.max(h, BUTTON_ADAPTER_CONFIG.minButtonHeight), BUTTON_ADAPTER_CONFIG.maxButtonHeight);
            btn.style.height = h + 'px';
            btn.style.lineHeight = h + 'px';
            processedButtons.add(btn);
        }
    }

    function scheduleButtonAdaptationForRow(row) {
        if (!row || !BUTTON_ADAPTER_CONFIG.isEnabled) return;
        setTimeout(() => {
            const btns = row.querySelectorAll(BUTTON_ADAPTER_CONFIG.targetButtons);
            btns.forEach(btn => { if (isTargetButton(btn)) adaptButtonHeight(btn); });
        }, 800);
    }

    function bindShortcut() {
        document.addEventListener('keydown', (e) => {
            if (e.altKey && e.key.toLowerCase() === 'z') {
                isTranslationEnabled = !isTranslationEnabled;
                saveSettings();
                controlPanel.querySelector('#translation-toggle').checked = isTranslationEnabled;
                if (isTranslationEnabled) reprocessTranslationsOnly();
                else removeTranslationsOnly();
                showNotification(`ç¿»è¯‘å·²${isTranslationEnabled?'å¼€å¯':'å…³é—­'}`);
            }
        });
    }

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
    else init();

})();
