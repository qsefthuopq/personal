// ==UserScript==
// @name         å·¥ä½œå°æ–‡æœ¬ç¿»è¯‘|å¤åˆ¶æŒ‰é’®|è‡ªåŠ¨ç¼©æ”¾|å¼ºåŠ›ä¿®å¤ç‰ˆ
// @namespace    http://tampermonkey.net/
// @version      8.4.0
// @description  ä¿®å¤v8.4ï¼šè§£å†³å†…å®¹è¢«é‡ç½®å¯¼è‡´åŠŸèƒ½å¤±æ•ˆçš„é—®é¢˜ï½œè‡ªåŠ¨ç¿»è¯‘ï½œç¬¬8åˆ—å¤åˆ¶ï½œå¿«æ·é”®(-/=)
// @author       You
// @match        https://breeze.opd.easebar.com/*
// @grant        GM_xmlhttpRequest
// @grant        GM_notification
// @grant        GM_getValue
// @grant        GM_setValue
// @connect      translate.googleapis.com
// @run-at       document-idle
// ==/UserScript==

(function () {
    'use strict';

    // ====== æ ¸å¿ƒé…ç½® ======
    const COLUMN_INDEX = 8; // ç¬¬8åˆ—
    const MAX_CELL_HEIGHT = 165;
    const SINGLE_LINE_HEIGHT = 50;
    let MIN_FONT_SIZE = 16;
    let MAX_FONT_SIZE = 32;
    let SINGLE_LINE_CHAR_LIMIT = 60;
    
    // ç±»åå¸¸é‡
    const WRAPPER_CLASS = 'fixed-height-cell';
    const COPY_BTN_CLASS = 'copy-original-btn';
    const ROLE_COPY_BTN_CLASS = 'copy-role-combined-btn';
    const ROLE_ID_ONLY_COPY_BTN_CLASS = 'copy-role-id-only-btn';
    const EXPANDED_CLASS = 'expanded-full';

    // ====== çŠ¶æ€å˜é‡ ======
    let isTranslationEnabled = true;
    const translationCache = new Map();
    let processing = false;
    let processDebounceTimer = null;
    let roleIdColumnIndexes = [];
    let globalMeasureContainer = null;
    
    // æŒ‰é’®é€‚é…é…ç½®
    const BUTTON_ADAPTER_CONFIG = {
        isEnabled: false,
        targetButtons: 'button.ant-btn',
        targetTexts: ['Forbid', 'Rename', 'Punish'],
        minHeight: 20,
        maxHeight: 140,
        offset: -18
    };
    const processedButtons = new WeakSet();

    // æ§åˆ¶é¢æ¿å˜é‡
    let controlPanelMinimized = true;
    let controlPanel = null;

    // ====== åˆå§‹åŒ– ======
    function init() {
        console.log('v8.4.0 å¼ºåŠ›ä¿®å¤ç‰ˆå·²åŠ è½½');
        loadSettings();
        addGlobalStyle();
        createMeasureContainer();
        createControlPanel();
        bindShortcut();
        
        // å¯åŠ¨ç›‘æ§
        startStableMonitoring();
        
        // æŒ‰é’®é«˜åº¦é€‚é…å®šæ—¶å™¨
        setInterval(() => {
            if (BUTTON_ADAPTER_CONFIG.isEnabled) processAllTargetButtons();
        }, 800);

        // æš´åŠ›é‡è¯•åˆå§‹åŒ–ï¼Œç¡®ä¿è¡¨æ ¼åŠ è½½åèƒ½å¤„ç†
        const retryInit = () => {
            processAllCellsInBatches();
            addRoleButtons();
        };
        setTimeout(retryInit, 1000);
        setTimeout(retryInit, 3000);
        setTimeout(retryInit, 5000);
        
        // æ™ºèƒ½æ»šåŠ¨
        initSmartScrollHandling();
    }

    // ====== æ ¸å¿ƒå¤„ç†é€»è¾‘ (ä¿®å¤åŠŸèƒ½ä¸¢å¤±çš„å…³é”®) ======
    function processAllCellsInBatches() {
        if (processing) return;
        processing = true;

        // 1. è·å–æ‰€æœ‰ç¬¬8åˆ—å•å…ƒæ ¼
        const allCells = document.querySelectorAll(`.ant-table-tbody > tr > td:nth-child(${COLUMN_INDEX})`);
        
        // 2. ç­›é€‰å‡ºâ€œæœªæ­£ç¡®åŒ…è£…â€çš„å•å…ƒæ ¼
        // ä¿®å¤ç‚¹ï¼šä¸å†ä¾èµ– datasetï¼Œè€Œæ˜¯æ£€æŸ¥å†…éƒ¨æ˜¯å¦å­˜åœ¨ wrapperã€‚
        // å¦‚æœ React/AntD é‡ç½®äº†å•å…ƒæ ¼å†…å®¹ï¼Œ wrapper ä¼šæ¶ˆå¤±ï¼Œè¿™é‡Œå°±èƒ½æ£€æµ‹åˆ°å¹¶é‡æ–°å¤„ç†ã€‚
        const cellsToProcess = Array.from(allCells).filter(cell => {
            // æ’é™¤æ­£åœ¨ç¼–è¾‘æˆ–ç©ºå•å…ƒæ ¼
            if (cell.querySelector('input') || cell.querySelector('textarea')) return false;
            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰äº†åŒ…è£…å®¹å™¨
            const hasWrapper = cell.querySelector(`.${WRAPPER_CLASS}`);
            return !hasWrapper && cell.textContent.trim().length > 0;
        }).slice(0, 50); // æ¯æ¬¡å¤„ç†50ä¸ªï¼Œé˜²æ­¢å¡é¡¿

        if (cellsToProcess.length === 0) {
            processing = false;
            return;
        }

        // 3. å¤„ç†è¿™ä¸€æ‰¹
        cellsToProcess.forEach(cell => {
            wrapCellContent(cell);
        });

        // 4. å¼‚æ­¥æ‰§è¡Œç¿»è¯‘å’Œå­—ä½“è°ƒæ•´ (é¿å…é˜»å¡ä¸»çº¿ç¨‹)
        setTimeout(() => {
            cellsToProcess.forEach(cell => {
                adjustFontSizeForCell(cell);
                if (isTranslationEnabled) translateIfNeeded(cell);
                if (BUTTON_ADAPTER_CONFIG.isEnabled) adaptButtonsInRow(cell.closest('tr'));
            });
        }, 0);

        processing = false;
        
        // å¦‚æœè¿˜æœ‰æœªå¤„ç†çš„ï¼Œç»§ç»­è°ƒåº¦
        if (allCells.length > cellsToProcess.length) {
            setTimeout(processAllCellsInBatches, 100);
        }
    }

    function wrapCellContent(cell) {
        // è·å–çº¯æ–‡æœ¬ï¼Œç§»é™¤å¯èƒ½æ®‹ç•™çš„æŒ‰é’®
        const text = getCleanText(cell);
        if (!text) return;

        // æ¸…ç©ºå•å…ƒæ ¼ï¼Œé‡å»ºç»“æ„
        cell.innerHTML = '';
        cell.dataset.originalText = text; // å¤‡ä»½åŸæ–‡

        // åˆ›å»ºå›ºå®šé«˜åº¦å®¹å™¨
        const container = document.createElement('div');
        container.className = WRAPPER_CLASS;
        
        const originalSpan = document.createElement('span');
        originalSpan.className = 'original';
        originalSpan.textContent = text;
        
        container.appendChild(originalSpan);
        cell.appendChild(container);

        // æ·»åŠ ç¬¬8åˆ—å¤åˆ¶æŒ‰é’®
        addCopyBtn(cell);

        // ç»‘å®šé•¿æ–‡æœ¬ç‚¹å‡»äº‹ä»¶
        if (text.length > SINGLE_LINE_CHAR_LIMIT) {
            container.classList.add('long-text');
            container.onclick = (e) => {
                e.stopPropagation();
                container.classList.toggle(EXPANDED_CLASS);
                if (container.classList.contains(EXPANDED_CLASS)) {
                    container.style.fontSize = '16px';
                } else {
                    adjustFontSizeForCell(cell);
                }
            };
        }
    }

    function getCleanText(cell) {
        const clone = cell.cloneNode(true);
        // ç§»é™¤æ‰€æœ‰æŒ‰é’®å†è·å–æ–‡æœ¬
        clone.querySelectorAll('div[class*="btn"], button').forEach(el => el.remove());
        return clone.textContent.trim();
    }

    // ====== ç›‘æ§ç³»ç»Ÿ (æ€§èƒ½ä¼˜åŒ–ï¼šå¿½ç•¥ Popover) ======
    function startStableMonitoring() {
        const observer = new MutationObserver((mutations) => {
            let shouldProcess = false;
            for (const mutation of mutations) {
                const target = mutation.target;
                
                // æ ¸å¿ƒä¼˜åŒ–ï¼šå¦‚æœå˜åŠ¨å‘ç”Ÿåœ¨ Popover/Tooltip å†…éƒ¨ï¼Œç›´æ¥å¿½ç•¥
                if (target.nodeType === 1) {
                    if (target.closest('.ant-popover') || 
                        target.closest('.ant-tooltip') || 
                        target.closest('.ant-dropdown') ||
                        target.classList.contains('ant-popover') ||
                        target.classList.contains('ant-tooltip')) {
                        continue;
                    }
                }

                // æ£€æµ‹è¡¨æ ¼è¡Œå˜åŒ–
                if (mutation.type === 'childList') {
                    for (const node of mutation.addedNodes) {
                        if (node.nodeType === 1) {
                            if (node.tagName === 'TR' || node.querySelector('.ant-table-tbody') || node.tagName === 'TD') {
                                shouldProcess = true;
                                break;
                            }
                        }
                    }
                }
                if (shouldProcess) break;
            }

            if (shouldProcess) {
                if (processDebounceTimer) clearTimeout(processDebounceTimer);
                processDebounceTimer = setTimeout(() => {
                    processAllCellsInBatches();
                    addRoleButtons();
                }, 500); // 500ms é˜²æŠ–
            }
        });

        observer.observe(document.body, {
            childList: true,
            subtree: true,
            attributes: false // ä¸ç›‘å¬å±æ€§ï¼Œæå‡æ€§èƒ½
        });
    }

    // ====== ç¿»è¯‘åŠŸèƒ½ ======
    async function translateIfNeeded(cell) {
        if (cell.dataset.translated === 'true') return;
        const text = cell.dataset.originalText;
        if (!text || text.length < 2) return;

        if (translationCache.has(text)) {
            applyTranslation(cell, translationCache.get(text));
            return;
        }

        try {
            const res = await translateText(text);
            if (res && res !== text) {
                translationCache.set(text, res);
                applyTranslation(cell, res);
            }
        } catch (e) {}
    }

    function applyTranslation(cell, transText) {
        const container = cell.querySelector(`.${WRAPPER_CLASS}`);
        if (!container || container.querySelector('.translation')) return;

        const transSpan = document.createElement('span');
        transSpan.className = 'translation';
        transSpan.textContent = transText;
        container.appendChild(transSpan);
        
        cell.dataset.translated = 'true';
        adjustFontSizeForCell(cell);
    }

    function translateText(text) {
        return new Promise(resolve => {
            GM_xmlhttpRequest({
                method: 'GET',
                url: `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=zh-CN&dt=t&q=${encodeURIComponent(text)}`,
                onload: r => {
                    try {
                        const data = JSON.parse(r.responseText);
                        resolve(data[0].map(x => x[0]).join(''));
                    } catch(e) { resolve(text); }
                },
                onerror: () => resolve(text)
            });
        });
    }

    // ====== å­—ä½“ç¼©æ”¾ (å¤ç”¨å®¹å™¨ä¼˜åŒ–) ======
    function createMeasureContainer() {
        if (globalMeasureContainer) return;
        globalMeasureContainer = document.createElement('div');
        globalMeasureContainer.style.cssText = 'position:absolute;left:-9999px;top:0;visibility:hidden;white-space:pre-wrap;word-wrap:break-word;line-height:1.1;padding:4px 6px;box-sizing:border-box;';
        document.body.appendChild(globalMeasureContainer);
    }

    function adjustFontSizeForCell(cell) {
        const container = cell.querySelector(`.${WRAPPER_CLASS}`);
        if (!container || container.classList.contains(EXPANDED_CLASS)) return;

        let text = '';
        const orig = container.querySelector('.original');
        const trans = container.querySelector('.translation');
        if (orig) text += orig.textContent;
        if (trans) text += ' ' + trans.textContent;
        if (!text) text = cell.dataset.originalText || '';

        if (!globalMeasureContainer) createMeasureContainer();
        globalMeasureContainer.style.width = container.clientWidth + 'px';
        globalMeasureContainer.textContent = text;

        let size = MAX_FONT_SIZE;
        const isSingleLine = text.length <= SINGLE_LINE_CHAR_LIMIT;
        
        container.classList.toggle('single-line', isSingleLine);
        
        // ç®€å•çš„å‘ä¸‹é€¼è¿‘ç®—æ³•
        globalMeasureContainer.style.fontSize = size + 'px';
        const limitHeight = isSingleLine ? SINGLE_LINE_HEIGHT * 1.2 : MAX_CELL_HEIGHT;
        
        while (size > MIN_FONT_SIZE && globalMeasureContainer.scrollHeight > limitHeight) {
            size -= isSingleLine ? 2 : 1;
            globalMeasureContainer.style.fontSize = size + 'px';
        }
        
        container.style.fontSize = size + 'px';
        container.classList.toggle('no-scroll', container.scrollHeight <= MAX_CELL_HEIGHT + 5);
    }

    // ====== å¤åˆ¶æŒ‰é’® & RoleID ======
    function addCopyBtn(cell) {
        // åªæœ‰å½“æ²¡æœ‰æŒ‰é’®æ—¶æ‰æ·»åŠ 
        if (cell.querySelector(`.${COPY_BTN_CLASS}`)) return;
        
        const btn = document.createElement('div');
        btn.className = COPY_BTN_CLASS;
        btn.textContent = '+';
        btn.title = 'å¤åˆ¶åŸæ–‡';
        btn.onclick = (e) => {
            e.stopPropagation();
            copyText(cell.dataset.originalText || getCleanText(cell), btn, '+');
        };
        cell.appendChild(btn);
    }

    function addRoleButtons() {
        const headers = document.querySelectorAll('.ant-table-thead th');
        roleIdColumnIndexes = [];
        headers.forEach(h => {
            if (/role_?id/i.test(h.textContent)) {
                const idx = Array.from(h.parentElement.children).indexOf(h) + 1;
                if (idx !== COLUMN_INDEX && !roleIdColumnIndexes.includes(idx)) roleIdColumnIndexes.push(idx);
            }
        });

        roleIdColumnIndexes.forEach(idx => {
            document.querySelectorAll(`.ant-table-tbody > tr > td:nth-child(${idx})`).forEach(cell => {
                if (!cell.querySelector(`.${ROLE_COPY_BTN_CLASS}`)) {
                    const txt = getCleanText(cell);
                    if (!txt) return;

                    // ç»„åˆå¤åˆ¶ (+)
                    const btn1 = document.createElement('div');
                    btn1.className = ROLE_COPY_BTN_CLASS;
                    btn1.textContent = '+';
                    btn1.onclick = (e) => {
                        e.stopPropagation();
                        const row = cell.closest('tr');
                        const mainCell = row.querySelector(`td:nth-child(${COLUMN_INDEX})`);
                        const mainTxt = mainCell ? (mainCell.dataset.originalText || getCleanText(mainCell)) : '';
                        copyText(mainTxt + '\n' + txt, btn1, '+');
                    };
                    cell.style.position = 'relative';
                    cell.appendChild(btn1);

                    // ä»…IDå¤åˆ¶ (-)
                    const btn2 = document.createElement('div');
                    btn2.className = ROLE_ID_ONLY_COPY_BTN_CLASS;
                    btn2.textContent = '-';
                    btn2.onclick = (e) => {
                        e.stopPropagation();
                        copyText(txt, btn2, '-');
                    };
                    cell.appendChild(btn2);
                }
            });
        });
    }

    async function copyText(txt, btn, icon) {
        try {
            await navigator.clipboard.writeText(txt);
            btn.textContent = 'âœ“'; btn.classList.add('copied');
            setTimeout(() => { btn.textContent = icon; btn.classList.remove('copied'); }, 1000);
        } catch(e) {
            btn.textContent = 'âœ—'; btn.classList.add('error');
            setTimeout(() => { btn.textContent = icon; btn.classList.remove('error'); }, 1000);
        }
    }

    // ====== æŒ‰é’®é«˜åº¦é€‚é… ======
    function processAllTargetButtons() {
        document.querySelectorAll(BUTTON_ADAPTER_CONFIG.targetButtons).forEach(btn => {
            if (BUTTON_ADAPTER_CONFIG.targetTexts.some(t => btn.textContent.includes(t)) && !processedButtons.has(btn)) {
                adaptButtonHeight(btn);
            }
        });
    }

    function adaptButtonHeight(btn) {
        const row = btn.closest('tr');
        if (!row) return;
        const cell = row.querySelector(`td:nth-child(${COLUMN_INDEX}) .${WRAPPER_CLASS}`);
        if (!cell) return;
        
        let h = cell.scrollHeight + BUTTON_ADAPTER_CONFIG.offset;
        h = Math.min(Math.max(h, BUTTON_ADAPTER_CONFIG.minHeight), BUTTON_ADAPTER_CONFIG.maxHeight);
        
        btn.style.height = h + 'px';
        btn.style.lineHeight = h + 'px';
        processedButtons.add(btn);
    }

    function adaptButtonsInRow(row) {
        if (!row) return;
        setTimeout(() => {
            row.querySelectorAll(BUTTON_ADAPTER_CONFIG.targetButtons).forEach(btn => {
                if (BUTTON_ADAPTER_CONFIG.targetTexts.some(t => btn.textContent.includes(t))) adaptButtonHeight(btn);
            });
        }, 500);
    }

    // ====== æ ·å¼ ======
    function addGlobalStyle() {
        const css = `
            .ant-table-tbody > tr > td:nth-child(${COLUMN_INDEX}) { position: relative !important; padding: 0 !important; height: auto !important; }
            .${WRAPPER_CLASS} { position: relative; width: 100%; max-height: ${MAX_CELL_HEIGHT}px; overflow-y: auto; padding: 4px 6px; box-sizing: border-box; white-space: pre-wrap; word-wrap: break-word; font-family: system-ui; }
            .${WRAPPER_CLASS}.single-line { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; height: ${SINGLE_LINE_HEIGHT}px; line-height: ${SINGLE_LINE_HEIGHT}px; }
            .${WRAPPER_CLASS}.no-scroll { overflow: hidden; }
            .${WRAPPER_CLASS} .translation { display: inline; font-weight: bold; margin-left: 8px; }
            .${WRAPPER_CLASS}.long-text { cursor: pointer; background: rgba(24,144,255,0.05); }
            .${WRAPPER_CLASS}.${EXPANDED_CLASS} { max-height: none !important; overflow: visible !important; background: white; border: 1px solid #1890ff; padding: 8px; z-index: 999; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
            
            /* æŒ‰é’®æ ·å¼ */
            .${COPY_BTN_CLASS}, .${ROLE_COPY_BTN_CLASS}, .${ROLE_ID_ONLY_COPY_BTN_CLASS} { position: absolute; background: rgba(255,255,255,0.5); border: 1px solid #ccc; border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 20; color: #666; transition: all 0.2s; }
            .${COPY_BTN_CLASS} { top: 4px; right: 4px; width: 30px; height: 30px; font-size: 14px; }
            .${ROLE_COPY_BTN_CLASS} { top: 4px; right: 4px; width: 24px; height: 24px; font-size: 12px; font-weight: bold; }
            .${ROLE_ID_ONLY_COPY_BTN_CLASS} { top: 4px; left: 4px; width: 24px; height: 24px; font-size: 12px; font-weight: bold; }
            
            td:hover .${COPY_BTN_CLASS}, td:hover .${ROLE_COPY_BTN_CLASS}, td:hover .${ROLE_ID_ONLY_COPY_BTN_CLASS} { background: white; border-color: #1890ff; color: #1890ff; }
            .copied { color: #52c41a !important; border-color: #52c41a !important; }
            .error { color: #ff4d4f !important; border-color: #ff4d4f !important; }
        `;
        const style = document.createElement('style');
        style.textContent = css;
        document.head.appendChild(style);
    }

    // ====== æ™ºèƒ½æ»šåŠ¨ (é˜²æ­¢å†’æ³¡) ======
    function initSmartScrollHandling() {
        document.addEventListener('wheel', (e) => {
            const t = e.target.closest(`.${WRAPPER_CLASS}`);
            if (t && t.scrollHeight > t.clientHeight) {
                const top = t.scrollTop === 0;
                const bot = Math.abs(t.scrollHeight - t.scrollTop - t.clientHeight) < 1;
                const up = e.deltaY < 0;
                const down = e.deltaY > 0;
                if ((up && !top) || (down && !bot)) e.stopPropagation();
            }
        }, { passive: false, capture: true });
    }

    // ====== æ§åˆ¶é¢æ¿ & å¿«æ·é”® ======
    function createControlPanel() {
        controlPanel = document.createElement('div');
        controlPanel.style.cssText = 'position:fixed;top:20px;right:20px;z-index:10000;background:rgba(255,255,255,0.95);border:1px solid #ddd;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);font-size:12px;color:#333;overflow:hidden;';
        
        const html = `
            <div id="panel-mini" style="width:30px;height:30px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:#1890ff;font-weight:bold;background:rgba(24,144,255,0.1);">+</div>
            <div id="panel-full" style="display:none;width:250px;">
                <div style="padding:10px;background:#f0f2f5;display:flex;justify-content:space-between;cursor:move;" id="panel-head">
                    <b>ğŸ”§ ç¿»è¯‘åŠ©æ‰‹ v8.4</b><span id="panel-close" style="cursor:pointer;">âˆ’</span>
                </div>
                <div style="padding:15px;max-height:400px;overflow-y:auto;">
                    <label style="display:block;margin-bottom:8px;"><input type="checkbox" id="chk-trans" ${isTranslationEnabled?'checked':''}> å¯ç”¨ç¿»è¯‘ (Alt+Z)</label>
                    <label style="display:block;margin-bottom:8px;"><input type="checkbox" id="chk-adapt" ${BUTTON_ADAPTER_CONFIG.isEnabled?'checked':''}> æŒ‰é’®é«˜åº¦é€‚é… (=)</label>
                    <div style="margin:8px 0;">å­—ä½“èŒƒå›´: <input id="inp-min" value="${MIN_FONT_SIZE}" style="width:30px"> - <input id="inp-max" value="${MAX_FONT_SIZE}" style="width:30px"> px</div>
                    <div style="margin:8px 0;">å•è¡Œé™åˆ¶: <input id="inp-limit" value="${SINGLE_LINE_CHAR_LIMIT}" style="width:40px"> å­—ç¬¦</div>
                    <button id="btn-apply" style="width:100%;margin-top:10px;padding:5px;background:#1890ff;color:white;border:none;border-radius:4px;cursor:pointer;">åº”ç”¨è®¾ç½®</button>
                </div>
            </div>
        `;
        controlPanel.innerHTML = html;
        document.body.appendChild(controlPanel);

        // äº‹ä»¶ç»‘å®š
        const mini = controlPanel.querySelector('#panel-mini');
        const full = controlPanel.querySelector('#panel-full');
        const toggle = () => {
            controlPanelMinimized = !controlPanelMinimized;
            mini.style.display = controlPanelMinimized ? 'flex' : 'none';
            full.style.display = controlPanelMinimized ? 'none' : 'block';
            saveSettings();
        };
        mini.onclick = toggle;
        controlPanel.querySelector('#panel-close').onclick = toggle;
        
        if(controlPanelMinimized) { mini.style.display = 'flex'; full.style.display = 'none'; }
        else { mini.style.display = 'none'; full.style.display = 'block'; }

        // åŠŸèƒ½ç»‘å®š
        controlPanel.querySelector('#chk-trans').onchange = (e) => {
            isTranslationEnabled = e.target.checked;
            saveSettings();
            if(isTranslationEnabled) processAllCellsInBatches(); // é‡æ–°è§¦å‘ç¿»è¯‘
            else {
                document.querySelectorAll('.translation').forEach(el => el.remove());
                document.querySelectorAll(`.${WRAPPER_CLASS}`).forEach(el => delete el.parentElement.dataset.translated);
            }
        };
        
        controlPanel.querySelector('#chk-adapt').onchange = (e) => {
            BUTTON_ADAPTER_CONFIG.isEnabled = e.target.checked;
            saveSettings();
        };

        controlPanel.querySelector('#btn-apply').onclick = () => {
            MIN_FONT_SIZE = parseInt(controlPanel.querySelector('#inp-min').value);
            MAX_FONT_SIZE = parseInt(controlPanel.querySelector('#inp-max').value);
            SINGLE_LINE_CHAR_LIMIT = parseInt(controlPanel.querySelector('#inp-limit').value);
            saveSettings();
            processAllCellsInBatches();
            alert('è®¾ç½®å·²åº”ç”¨');
        };

        // æ‹–æ‹½
        const head = controlPanel.querySelector('#panel-head');
        let isDrag = false, startX, startY, initX, initY;
        head.onmousedown = e => { isDrag = true; startX = e.clientX; startY = e.clientY; initX = controlPanel.offsetLeft; initY = controlPanel.offsetTop; };
        document.onmousemove = e => { if(isDrag) { controlPanel.style.left = initX + e.clientX - startX + 'px'; controlPanel.style.top = initY + e.clientY - startY + 'px'; controlPanel.style.right = 'auto'; }};
        document.onmouseup = () => isDrag = false;
    }

    function bindShortcut() {
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;
            // Alt+Z åˆ‡æ¢ç¿»è¯‘
            if (e.altKey && e.key.toLowerCase() === 'z') {
                e.preventDefault();
                document.getElementById('chk-trans').click();
                GM_notification({text: `ç¿»è¯‘ ${isTranslationEnabled?'å¼€å¯':'å…³é—­'}`, timeout: 1000});
            }
            // - åˆ‡æ¢é¢æ¿
            if (e.key === '-' || e.code === 'Minus') {
                e.preventDefault();
                document.getElementById('panel-mini').click();
            }
            // = åˆ‡æ¢æŒ‰é’®é€‚é…
            if (e.key === '=' || e.code === 'Equal') {
                e.preventDefault();
                document.getElementById('chk-adapt').click();
                GM_notification({text: `æŒ‰é’®é€‚é… ${BUTTON_ADAPTER_CONFIG.isEnabled?'å¼€å¯':'å…³é—­'}`, timeout: 1000});
            }
        });
    }

    function loadSettings() {
        try {
            isTranslationEnabled = GM_getValue('isTranslationEnabled', true);
            BUTTON_ADAPTER_CONFIG.isEnabled = GM_getValue('isAdapterEnabled', false);
            controlPanelMinimized = GM_getValue('isPanelMinimized', true);
            MIN_FONT_SIZE = GM_getValue('minFont', 16);
        } catch(e) {}
    }
    function saveSettings() {
        GM_setValue('isTranslationEnabled', isTranslationEnabled);
        GM_setValue('isAdapterEnabled', BUTTON_ADAPTER_CONFIG.isEnabled);
        GM_setValue('isPanelMinimized', controlPanelMinimized);
        GM_setValue('minFont', MIN_FONT_SIZE);
    }

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
    else init();
})();
