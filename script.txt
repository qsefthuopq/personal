// ==UserScript==
// @name         å·¥ä½œå°æ–‡æœ¬ç¿»è¯‘|å¤åˆ¶æŒ‰é’®|è‡ªåŠ¨ç¼©æ”¾|æ€§èƒ½ä¼˜åŒ–ç‰ˆ
// @namespace    http://tampermonkey.net/
// @version      8.1.0
// @description  æ€§èƒ½ä¼˜åŒ–ç‰ˆæœ¬ï¼šè§£å†³Ant-Popoverå¡é¡¿ï½œä¿®å¤å¤åˆ¶å¤±æ•ˆï½œä¿®å¤ç›¸åŒå†…å®¹ä¸å¤„ç†ï½œæ™ºèƒ½é˜²æŠ–
// @author       You
// @match        https://breeze.opd.easebar.com/*
// @grant        GM_xmlhttpRequest
// @grant        GM_notification
// @grant        GM_getValue
// @grant        GM_setValue
// @connect      translate.googleapis.com
// @run-at       document-idle
// ==/UserScript==

(function () {
    'use strict';

    // ====== é…ç½® ======
    const COLUMN_INDEX = 8; // åªå¤„ç†ç¬¬8åˆ—
    let MIN_FONT_SIZE = 16;
    let MAX_FONT_SIZE = 32;
    const MAX_CELL_HEIGHT = 165;
    const SINGLE_LINE_HEIGHT = 50;
    const BATCH_SIZE = 50; // å¢åŠ æ‰¹å¤„ç†å¤§å°
    let SINGLE_LINE_CHAR_LIMIT = 60;
    const COPY_BTN_CLASS = 'copy-original-btn';
    const ROLE_COPY_BTN_CLASS = 'copy-role-combined-btn';
    const ROLE_ID_ONLY_COPY_BTN_CLASS = 'copy-role-id-only-btn';
    const EXPANDED_CLASS = 'expanded-full';

    // ====== æ€§èƒ½ä¼˜åŒ–é…ç½® ======
    const PERFORMANCE_CONFIG = {
        debounceDelay: 300,
        maxCellsPerBatch: 100, // æé«˜å•æ¬¡å¤„ç†ä¸Šé™
        smartScrollEnabled: true
    };

    // ====== æ™ºèƒ½æŒ‰é’®é«˜åº¦é€‚é…é…ç½® ======
    const BUTTON_ADAPTER_CONFIG = {
        targetButtons: 'button.ant-btn',
        targetButtonTexts: ['Forbid', 'Rename', 'Punish'],
        isEnabled: false,
        minButtonHeight: 20,
        maxButtonHeight: 140,
        buttonHeightOffset: -18
    };

    let isTranslationEnabled = true;
    const translationCache = new Map();
    let isProcessing = false;
    let processDebounceTimer = null;
    let roleIdColumnIndexes = [];
    let observer = null;
    
    // å…¨å±€å¤ç”¨çš„æµ‹é‡å®¹å™¨ï¼Œé¿å…é¢‘ç¹åˆ›å»ºDOM
    let measureContainer = null;

    // ====== æ§åˆ¶é¢æ¿å˜é‡ ======
    let controlPanel = null;
    let controlPanelMinimized = true;

    function log(msg, data) {
        // console.log(`[ç¿»è¯‘åŠ©æ‰‹] ${msg}`, data || '');
    }

    function init() {
        console.log('å·¥ä½œå°ç¿»è¯‘åŠ©æ‰‹ v8.1.0 (æ€§èƒ½ä¼˜åŒ–ç‰ˆ) å·²åŠ è½½');
        loadSettings();
        addGlobalStyle();
        createMeasureContainer(); // åˆ›å»ºå…¨å±€æµ‹é‡å®¹å™¨
        bindShortcut();
        createControlPanel();
        startStableMonitoring();
        
        // å»¶è¿Ÿåˆå§‹åŒ–æ»šåŠ¨å¤„ç†
        setTimeout(() => {
            initSmartScrollHandling();
            processAllCellsInBatches();
        }, 2000);
    }

    // ====== å…¨å±€æµ‹é‡å®¹å™¨ (æ€§èƒ½ä¼˜åŒ–å…³é”®) ======
    function createMeasureContainer() {
        if (measureContainer) return;
        measureContainer = document.createElement('div');
        measureContainer.id = 'global-text-measure-container';
        measureContainer.style.cssText = `
            position: absolute;
            left: -9999px;
            top: 0;
            visibility: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.1;
            padding: 4px 6px;
            box-sizing: border-box;
            pointer-events: none;
            z-index: -1;
        `;
        document.body.appendChild(measureContainer);
    }

    // ====== æ™ºèƒ½æ»šåŠ¨å¤„ç† ======
    function initSmartScrollHandling() {
        if (!PERFORMANCE_CONFIG.smartScrollEnabled) return;
        
        // ä½¿ç”¨ passive: false æ¥å…è®¸ preventDefaultï¼Œä½†ä»…åœ¨å¿…è¦æ—¶
        const handleWheel = (e) => {
            const target = e.target;
            const fixedHeightCell = target.closest('.fixed-height-cell');
            
            if (fixedHeightCell && fixedHeightCell.scrollHeight > fixedHeightCell.clientHeight) {
                // åªæœ‰å½“åœ¨æ»šåŠ¨å®¹å™¨å†…ä¸”éœ€è¦æ»šåŠ¨æ—¶æ‰é˜»æ­¢å†’æ³¡
                const isScrollTop = fixedHeightCell.scrollTop === 0;
                const isScrollBottom = Math.abs(fixedHeightCell.scrollHeight - fixedHeightCell.scrollTop - fixedHeightCell.clientHeight) < 1;
                
                // å¦‚æœå‘ä¸Šæ»šåŠ¨ä¸”åœ¨é¡¶éƒ¨ï¼Œæˆ–å‘ä¸‹æ»šåŠ¨ä¸”åœ¨åº•éƒ¨ï¼Œåˆ™è®©å¤–å±‚å¤„ç†ï¼ˆä¸é˜»æ­¢ï¼‰
                // å¦åˆ™ï¼Œé˜»æ­¢å¤–å±‚æ»šåŠ¨ï¼Œåªæ»šåŠ¨å†…éƒ¨
                const delta = e.deltaY || e.detail || (e.wheelDelta ? -e.wheelDelta : 0);
                if ((delta < 0 && !isScrollTop) || (delta > 0 && !isScrollBottom)) {
                    e.stopPropagation();
                }
            }
        };

        document.addEventListener('wheel', handleWheel, { passive: false, capture: true });
    }

    function loadSettings() {
        try {
            const savedTranslation = GM_getValue('translationEnabled');
            const savedAdapter = GM_getValue('buttonAdapterEnabled');
            const savedPanel = GM_getValue('panelMinimized');
            
            if (savedTranslation !== undefined) isTranslationEnabled = savedTranslation;
            if (savedAdapter !== undefined) BUTTON_ADAPTER_CONFIG.isEnabled = savedAdapter;
            if (savedPanel !== undefined) controlPanelMinimized = savedPanel;
            
            // è¯»å–å­—ä½“è®¾ç½®
            const minFont = GM_getValue('minFontSize');
            if (minFont) MIN_FONT_SIZE = minFont;
            const maxFont = GM_getValue('maxFontSize');
            if (maxFont) MAX_FONT_SIZE = maxFont;
        } catch (e) { console.error(e); }
    }

    function saveSettings() {
        GM_setValue('translationEnabled', isTranslationEnabled);
        GM_setValue('buttonAdapterEnabled', BUTTON_ADAPTER_CONFIG.isEnabled);
        GM_setValue('panelMinimized', controlPanelMinimized);
        GM_setValue('minFontSize', MIN_FONT_SIZE);
        GM_setValue('maxFontSize', MAX_FONT_SIZE);
    }

    // ====== æ ¸å¿ƒç›‘æ§é€»è¾‘ (ä¼˜åŒ–ç‰ˆ) ======
    function startStableMonitoring() {
        // æ ¸å¿ƒä¼˜åŒ–ï¼šå¿½ç•¥ Popover/Tooltip ç­‰å¼•èµ·çš„é«˜é¢‘ DOM å˜åŠ¨
        const ignoreSelectors = ['.ant-popover', '.ant-tooltip', '.ant-dropdown', '.ant-message', 'script', 'style'];
        
        observer = new MutationObserver((mutations) => {
            let shouldProcess = false;
            let isTableUpdate = false;

            for (const mutation of mutations) {
                // 1. å¦‚æœå˜æ›´çš„ç›®æ ‡æ˜¯å¿½ç•¥åˆ—è¡¨ä¸­çš„å…ƒç´ ï¼Œç›´æ¥è·³è¿‡
                const target = mutation.target;
                if (target.nodeType === 1) {
                    if (ignoreSelectors.some(sel => target.closest(sel) || target.matches(sel))) {
                        continue;
                    }
                }

                // 2. æ£€æŸ¥æ˜¯å¦æ˜¯è¡¨æ ¼ç›¸å…³çš„å˜æ›´
                if (mutation.type === 'childList') {
                    // æ£€æŸ¥å¢åŠ çš„èŠ‚ç‚¹
                    for (const node of mutation.addedNodes) {
                        if (node.nodeType === 1) {
                            if (node.tagName === 'TR' || node.tagName === 'TD' || node.classList.contains('ant-table-tbody')) {
                                isTableUpdate = true;
                                break;
                            }
                            // æ£€æŸ¥æ˜¯å¦åŒ…å«äº†è¡¨æ ¼
                            if (node.querySelector && node.querySelector('.ant-table-tbody')) {
                                isTableUpdate = true;
                                break;
                            }
                        }
                    }
                }
                
                if (isTableUpdate) {
                    shouldProcess = true;
                    break;
                }
            }

            if (shouldProcess) {
                scheduleProcessNewCells();
            }
        });

        observer.observe(document.body, {
            childList: true,
            subtree: true,
            attributes: false // ä¸ç›‘å¬å±æ€§å˜åŒ–ï¼Œå‡å°‘è§¦å‘
        });
    }

    function scheduleProcessNewCells() {
        if (processDebounceTimer) {
            clearTimeout(processDebounceTimer);
        }
        processDebounceTimer = setTimeout(() => {
            processAllCellsInBatches();
            findRoleIdColumns();
            if (roleIdColumnIndexes.length > 0) {
                addCopyButtonsToRoleIdColumns();
                addRoleIdOnlyCopyButtons();
            }
        }, PERFORMANCE_CONFIG.debounceDelay);
    }

    // ====== å•å…ƒæ ¼å¤„ç†é€»è¾‘ ======
    function processAllCellsInBatches() {
        if (isProcessing) return;
        isProcessing = true;

        try {
            // è·å–æ‰€æœ‰æœªå¤„ç†çš„ç¬¬8åˆ—å•å…ƒæ ¼
            // ä¿®å¤ï¼šä¸å†ä¾èµ– Set å»é‡ï¼Œè€Œæ˜¯ç›´æ¥æ£€æŸ¥ dataset æ ‡è®°ï¼Œè§£å†³ç›¸åŒå†…å®¹è¡Œä¸å¤„ç†çš„é—®é¢˜
            const allTargetCells = document.querySelectorAll(`.ant-table-tbody > tr > td:nth-child(${COLUMN_INDEX}):not([data-processed="true"])`);
            
            const cellsToProcess = Array.from(allTargetCells).slice(0, PERFORMANCE_CONFIG.maxCellsPerBatch);

            if (cellsToProcess.length > 0) {
                // ç¬¬ä¸€æ­¥ï¼šåŒæ­¥è¿›è¡Œè½»é‡çº§çš„ DOM ç»“æ„åŒ…è£…
                cellsToProcess.forEach(cell => {
                    const text = getCleanCellText(cell);
                    if (text && text.length > 1) {
                        wrapCellContent(cell, text);
                        cell.dataset.processed = 'true'; // æ ‡è®°å·²å¤„ç†
                    }
                });

                // ç¬¬äºŒæ­¥ï¼šå¼‚æ­¥è¿›è¡Œè€—æ—¶çš„è®¡ç®—å’Œç¿»è¯‘
                setTimeout(() => {
                    cellsToProcess.forEach(cell => {
                        if (cell.dataset.processed === 'true') {
                            adjustFontSizeForCell(cell);
                            if (isTranslationEnabled && cell.dataset.translated !== 'true') {
                                translateIfNeeded(cell);
                            }
                        }
                    });
                    
                    // å¦‚æœè¿˜æœ‰å‰©ä½™æœªå¤„ç†çš„ï¼Œç»§ç»­è°ƒåº¦
                    if (allTargetCells.length > cellsToProcess.length) {
                        setTimeout(processAllCellsInBatches, 100);
                    }
                }, 0);
            }
            
            // æŒ‰é’®é€‚é…æ£€æŸ¥
            if (BUTTON_ADAPTER_CONFIG.isEnabled) {
                setTimeout(processAllTargetButtons, 200);
            }

        } catch (e) {
            console.error('å¤„ç†å•å…ƒæ ¼å‡ºé”™:', e);
        } finally {
            isProcessing = false;
        }
    }

    function wrapCellContent(cell, text) {
        // æ¸…ç©ºå¹¶é‡å»ºç»“æ„
        cell.innerHTML = '';
        cell.dataset.originalText = text;

        const container = document.createElement('div');
        container.className = 'fixed-height-cell';
        
        const originalSpan = document.createElement('span');
        originalSpan.className = 'original';
        originalSpan.textContent = text;

        container.appendChild(originalSpan);
        cell.appendChild(container);
        
        // æ·»åŠ å¤åˆ¶æŒ‰é’®
        addCopyButtonToCell(cell);
        
        // ç»‘å®šé•¿æ–‡æœ¬ç‚¹å‡»äº‹ä»¶
        if (text.length > SINGLE_LINE_CHAR_LIMIT) {
             container.addEventListener('click', (e) => {
                e.stopPropagation(); // é˜²æ­¢å†’æ³¡è§¦å‘ AntD è¡Œç‚¹å‡»
                toggleFullDisplay(cell);
            });
        }
    }

    // ====== å­—ä½“è°ƒæ•´ (æ€§èƒ½ä¼˜åŒ–ç‰ˆ) ======
    function adjustFontSizeForCell(cell) {
        const container = cell.querySelector('.fixed-height-cell');
        if (!container || container.classList.contains(EXPANDED_CLASS)) return;

        // è·å–æ–‡æœ¬å†…å®¹
        let displayText = '';
        const originalSpan = container.querySelector('.original');
        const translationSpan = container.querySelector('.translation');
        
        if (originalSpan) displayText += originalSpan.textContent;
        if (translationSpan) displayText += ' ' + translationSpan.textContent;
        if (!displayText) displayText = cell.dataset.originalText || '';

        // ä½¿ç”¨å…¨å±€æµ‹é‡å®¹å™¨ï¼Œé¿å…åˆ›å»ºæ–°èŠ‚ç‚¹
        if (!measureContainer) createMeasureContainer();
        
        measureContainer.textContent = displayText;
        measureContainer.style.width = `${container.clientWidth}px`;
        measureContainer.style.display = 'block'; // ä¸´æ—¶æ˜¾ç¤ºä»¥æµ‹é‡

        // äºŒåˆ†æŸ¥æ‰¾ä¼˜åŒ–æˆ–å¿«é€Ÿé€¼è¿‘
        let optimalSize = MIN_FONT_SIZE;
        
        // å¿«é€Ÿæ£€æŸ¥æœ€å¤§å­—ä½“
        measureContainer.style.fontSize = `${MAX_FONT_SIZE}px`;
        if (measureContainer.scrollHeight <= MAX_CELL_HEIGHT) {
            optimalSize = MAX_FONT_SIZE;
        } else {
            // ä»æœ€å¤§å¾€ä¸‹å°è¯•ï¼Œæ­¥é•¿ç¨å¤§ä¸€ç‚¹æé«˜é€Ÿåº¦
            for (let size = MAX_FONT_SIZE; size >= MIN_FONT_SIZE; size -= 2) {
                measureContainer.style.fontSize = `${size}px`;
                if (measureContainer.scrollHeight <= MAX_CELL_HEIGHT) {
                    optimalSize = size;
                    break;
                }
            }
        }

        measureContainer.style.display = 'none'; // éšè—
        container.style.fontSize = `${optimalSize}px`;
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦æ»šåŠ¨æ¡æ ·å¼
        if (container.scrollHeight > MAX_CELL_HEIGHT + 5) {
            container.classList.add('long-text');
        } else {
            container.classList.remove('long-text');
        }
    }

    // ====== å¤åˆ¶æŒ‰é’®ç›¸å…³ ======
    function addCopyButtonToCell(cell) {
        // é¿å…é‡å¤æ·»åŠ 
        if (cell.querySelector(`.${COPY_BTN_CLASS}`)) return;

        const copyBtn = document.createElement('div');
        copyBtn.className = COPY_BTN_CLASS;
        copyBtn.textContent = '+';
        copyBtn.title = 'å¤åˆ¶åŸæ–‡';

        copyBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
            
            const text = cell.dataset.originalText || getCleanCellText(cell);
            copyTextToClipboard(text, copyBtn);
        });

        cell.style.position = 'relative';
        cell.appendChild(copyBtn);
    }

    // è¾…åŠ©ï¼šè·å–çº¯å‡€æ–‡æœ¬ï¼ˆæ’é™¤æŒ‰é’®ï¼‰
    function getCleanCellText(cell) {
        if (!cell) return '';
        // ä½¿ç”¨ TreeWalker æˆ–ç®€å•çš„å…‹éš†èŠ‚ç‚¹è¿‡æ»¤
        const clone = cell.cloneNode(true);
        const ignores = clone.querySelectorAll(`.${COPY_BTN_CLASS}, .${ROLE_COPY_BTN_CLASS}, .${ROLE_ID_ONLY_COPY_BTN_CLASS}, button`);
        ignores.forEach(el => el.remove());
        return clone.textContent.trim();
    }

    async function copyTextToClipboard(text, btnElement) {
        try {
            await navigator.clipboard.writeText(text);
            const originalText = btnElement.textContent;
            btnElement.textContent = 'âœ“';
            btnElement.classList.add('copied');
            setTimeout(() => {
                btnElement.textContent = originalText;
                btnElement.classList.remove('copied');
            }, 1000);
        } catch (err) {
            btnElement.textContent = 'âœ—';
            setTimeout(() => {
                btnElement.textContent = '+';
            }, 1000);
        }
    }

    // ====== ç¿»è¯‘é€»è¾‘ ======
    async function translateIfNeeded(cell) {
        const originalText = cell.dataset.originalText;
        if (!originalText || originalText.length < 2) return;

        // æ£€æŸ¥ç¼“å­˜
        if (translationCache.has(originalText)) {
            applyTranslation(cell, translationCache.get(originalText));
            return;
        }

        try {
            const translated = await translateText(originalText);
            if (translated && translated !== originalText) {
                translationCache.set(originalText, translated);
                applyTranslation(cell, translated);
            }
        } catch (e) {
            // console.warn('Translation failed', e);
        }
    }

    function applyTranslation(cell, translatedText) {
        const container = cell.querySelector('.fixed-height-cell');
        if (!container) return;

        // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ç¿»è¯‘spanï¼Œé˜²æ­¢é‡å¤æ·»åŠ 
        if (container.querySelector('.translation')) return;

        const translationSpan = document.createElement('span');
        translationSpan.className = 'translation';
        translationSpan.textContent = translatedText;
        translationSpan.style.fontWeight = 'bold';
        translationSpan.style.marginLeft = '8px';

        container.appendChild(translationSpan);
        cell.dataset.translated = 'true';
        
        // ç¿»è¯‘åé‡æ–°è°ƒæ•´å­—ä½“
        adjustFontSizeForCell(cell);
        
        // å¦‚æœå¯ç”¨äº†æŒ‰é’®é€‚é…ï¼Œç¿»è¯‘åéœ€è¦é‡æ–°æ£€æŸ¥é«˜åº¦
        if (BUTTON_ADAPTER_CONFIG.isEnabled) {
            const row = cell.closest('tr');
            if (row) setTimeout(() => adaptButtonsInRow(row), 100);
        }
    }

    function translateText(text) {
        return new Promise((resolve) => {
            const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=zh-CN&dt=t&q=${encodeURIComponent(text)}`;
            GM_xmlhttpRequest({
                method: 'GET',
                url: url,
                timeout: 8000,
                onload: (res) => {
                    if (res.status === 200) {
                        try {
                            const data = JSON.parse(res.responseText);
                            let result = '';
                            if (data[0]) {
                                data[0].forEach(item => { if (item[0]) result += item[0]; });
                            }
                            resolve(result || text);
                        } catch (e) { resolve(text); }
                    } else { resolve(text); }
                },
                onerror: () => resolve(text),
                ontimeout: () => resolve(text)
            });
        });
    }

    // ====== Role ID ç›¸å…³åŠŸèƒ½ ======
    function findRoleIdColumns() {
        const headers = document.querySelectorAll('.ant-table-thead th');
        roleIdColumnIndexes = [];
        headers.forEach((th, idx) => {
            const text = th.textContent.toLowerCase();
            if (text.includes('role_id') || text.includes('roleid')) {
                const colIdx = idx + 1;
                if (colIdx !== COLUMN_INDEX && !roleIdColumnIndexes.includes(colIdx)) {
                    roleIdColumnIndexes.push(colIdx);
                }
            }
        });
    }

    function addCopyButtonsToRoleIdColumns() {
        roleIdColumnIndexes.forEach(colIdx => {
            const cells = document.querySelectorAll(`.ant-table-tbody > tr > td:nth-child(${colIdx})`);
            cells.forEach(cell => {
                if (cell.querySelector(`.${ROLE_COPY_BTN_CLASS}`)) return;
                const text = getCleanCellText(cell);
                if (!text) return;

                const btn = document.createElement('div');
                btn.className = ROLE_COPY_BTN_CLASS;
                btn.textContent = '+';
                btn.title = 'å¤åˆ¶åŸå†…å®¹+RoleID';
                btn.onclick = (e) => {
                    e.stopPropagation();
                    const row = cell.closest('tr');
                    const mainCell = row.querySelector(`td:nth-child(${COLUMN_INDEX})`);
                    const mainText = mainCell ? (mainCell.dataset.originalText || getCleanCellText(mainCell)) : '';
                    const roleText = getCleanCellText(cell);
                    copyTextToClipboard(`${mainText}\n${roleText}`, btn);
                };
                cell.style.position = 'relative';
                cell.appendChild(btn);
            });
        });
    }

    function addRoleIdOnlyCopyButtons() {
        roleIdColumnIndexes.forEach(colIdx => {
            const cells = document.querySelectorAll(`.ant-table-tbody > tr > td:nth-child(${colIdx})`);
            cells.forEach(cell => {
                if (cell.querySelector(`.${ROLE_ID_ONLY_COPY_BTN_CLASS}`)) return;
                const text = getCleanCellText(cell);
                if (!text) return;

                const btn = document.createElement('div');
                btn.className = ROLE_ID_ONLY_COPY_BTN_CLASS;
                btn.textContent = '-';
                btn.title = 'ä»…å¤åˆ¶RoleID';
                btn.onclick = (e) => {
                    e.stopPropagation();
                    const roleText = getCleanCellText(cell);
                    copyTextToClipboard(roleText, btn);
                };
                cell.style.position = 'relative';
                cell.appendChild(btn);
            });
        });
    }

    // ====== æŒ‰é’®é«˜åº¦é€‚é… (ä¼˜åŒ–ç‰ˆ) ======
    function processAllTargetButtons() {
        if (!BUTTON_ADAPTER_CONFIG.isEnabled) return;
        const buttons = document.querySelectorAll(BUTTON_ADAPTER_CONFIG.targetButtons);
        buttons.forEach(btn => {
            if (!btn.dataset.adapted && BUTTON_ADAPTER_CONFIG.targetButtonTexts.some(t => btn.textContent.includes(t))) {
                adaptButtonHeight(btn);
            }
        });
    }

    function adaptButtonsInRow(row) {
        const buttons = row.querySelectorAll(BUTTON_ADAPTER_CONFIG.targetButtons);
        buttons.forEach(btn => {
            if (BUTTON_ADAPTER_CONFIG.targetButtonTexts.some(t => btn.textContent.includes(t))) {
                adaptButtonHeight(btn);
            }
        });
    }

    function adaptButtonHeight(btn) {
        const row = btn.closest('tr');
        if (!row) return;
        
        // è·å–åŒè¡Œç¬¬8åˆ—çš„é«˜åº¦ä½œä¸ºå‚è€ƒ
        const mainCell = row.querySelector(`td:nth-child(${COLUMN_INDEX}) .fixed-height-cell`);
        if (mainCell) {
            let targetHeight = mainCell.scrollHeight + BUTTON_ADAPTER_CONFIG.buttonHeightOffset;
            // é™åˆ¶èŒƒå›´
            targetHeight = Math.max(BUTTON_ADAPTER_CONFIG.minButtonHeight, Math.min(BUTTON_ADAPTER_CONFIG.maxButtonHeight, targetHeight));
            
            btn.style.height = `${targetHeight}px`;
            btn.style.lineHeight = `${targetHeight}px`;
            btn.dataset.adapted = 'true';
        }
    }

    // ====== UI: å±•å¼€/æ”¶èµ· ======
    function toggleFullDisplay(cell) {
        const container = cell.querySelector('.fixed-height-cell');
        if (!container) return;
        
        container.classList.toggle(EXPANDED_CLASS);
        if (container.classList.contains(EXPANDED_CLASS)) {
            container.style.fontSize = '16px';
        } else {
            adjustFontSizeForCell(cell); // æ¢å¤æ—¶é‡æ–°è®¡ç®—å­—ä½“
        }
    }

    // ====== æ ·å¼æ³¨å…¥ ======
    function addGlobalStyle() {
        const style = document.createElement('style');
        style.textContent = `
            .ant-table-tbody > tr > td:nth-child(${COLUMN_INDEX}) {
                position: relative !important;
                padding: 0 !important;
                height: auto !important;
            }
            .fixed-height-cell {
                width: 100%;
                max-height: ${MAX_CELL_HEIGHT}px;
                overflow-y: auto;
                padding: 6px;
                box-sizing: border-box;
                white-space: pre-wrap;
                word-break: break-word;
                transition: all 0.2s;
            }
            .fixed-height-cell.long-text {
                cursor: pointer;
            }
            .fixed-height-cell.long-text:hover {
                background-color: rgba(24, 144, 255, 0.05);
            }
            .fixed-height-cell.${EXPANDED_CLASS} {
                max-height: none !important;
                z-index: 100;
                background: #fff;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                border-radius: 4px;
                padding: 12px;
            }
            .${COPY_BTN_CLASS} {
                position: absolute; top: 2px; right: 2px; width: 24px; height: 24px;
                line-height: 24px; text-align: center; background: rgba(255,255,255,0.8);
                border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 14px; color: #666;
                z-index: 10; display: none;
            }
            td:hover .${COPY_BTN_CLASS} { display: block; }
            .${COPY_BTN_CLASS}:hover { color: #1890ff; border-color: #1890ff; }
            
            .${ROLE_COPY_BTN_CLASS}, .${ROLE_ID_ONLY_COPY_BTN_CLASS} {
                position: absolute; top: 4px; width: 20px; height: 20px;
                line-height: 18px; text-align: center; background: rgba(255,255,255,0.6);
                border: 1px solid #ccc; border-radius: 3px; cursor: pointer;
                font-size: 12px; color: #555; z-index: 5;
            }
            .${ROLE_COPY_BTN_CLASS} { right: 4px; }
            .${ROLE_ID_ONLY_COPY_BTN_CLASS} { left: 4px; }
            .${ROLE_COPY_BTN_CLASS}:hover, .${ROLE_ID_ONLY_COPY_BTN_CLASS}:hover {
                background: #1890ff; color: #fff; border-color: #1890ff;
            }
            
            /* æ»šåŠ¨æ¡æ ·å¼ */
            .fixed-height-cell::-webkit-scrollbar { width: 4px; }
            .fixed-height-cell::-webkit-scrollbar-thumb { background: #ccc; border-radius: 2px; }
            
            /* æ§åˆ¶é¢æ¿æ ·å¼ */
            #trans-control-panel {
                position: fixed; top: 60px; right: 20px; z-index: 9999;
                background: white; border: 1px solid #ddd; border-radius: 6px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.15); font-size: 12px;
                transition: width 0.3s, height 0.3s; overflow: hidden;
            }
            .panel-header { padding: 8px; background: #f0f2f5; cursor: move; display: flex; justify-content: space-between; align-items: center;}
            .panel-content { padding: 12px; }
            .panel-row { margin-bottom: 8px; display: flex; align-items: center; }
            .panel-row input[type="checkbox"] { margin-right: 6px; }
            .panel-row input[type="number"] { width: 50px; margin-left: auto; }
            .minimized-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #1890ff; font-weight: bold;}
        `;
        document.head.appendChild(style);
    }

    function bindShortcut() {
        document.addEventListener('keydown', (e) => {
            // Alt+Z åˆ‡æ¢ç¿»è¯‘
            if (e.altKey && (e.key === 'z' || e.key === 'Z')) {
                isTranslationEnabled = !isTranslationEnabled;
                saveSettings();
                const check = document.getElementById('cb-translate');
                if(check) check.checked = isTranslationEnabled;
                
                GM_notification({text: `ç¿»è¯‘å·²${isTranslationEnabled ? 'å¼€å¯' : 'å…³é—­'}`, timeout: 1500});
                
                // é‡æ–°å¤„ç†æ‰€æœ‰å•å…ƒæ ¼
                document.querySelectorAll(`.ant-table-tbody > tr > td:nth-child(${COLUMN_INDEX})`).forEach(cell => {
                    cell.dataset.translated = isTranslationEnabled ? 'false' : 'disabled';
                    // é‡æ–°è§¦å‘å¤„ç†
                    if (isTranslationEnabled) translateIfNeeded(cell);
                    else {
                        const transSpan = cell.querySelector('.translation');
                        if (transSpan) transSpan.remove();
                        adjustFontSizeForCell(cell);
                    }
                });
            }
        });
    }

    function createControlPanel() {
        controlPanel = document.createElement('div');
        controlPanel.id = 'trans-control-panel';
        
        const updateView = () => {
            if (controlPanelMinimized) {
                controlPanel.innerHTML = `<div class="minimized-btn" title="å±•å¼€è®¾ç½®">+</div>`;
                controlPanel.style.width = '32px';
                controlPanel.style.height = '32px';
                controlPanel.querySelector('.minimized-btn').onclick = () => {
                    controlPanelMinimized = false;
                    saveSettings();
                    updateView();
                };
            } else {
                controlPanel.style.width = '220px';
                controlPanel.style.height = 'auto';
                controlPanel.innerHTML = `
                    <div class="panel-header">
                        <span>ğŸ”§ ç¿»è¯‘åŠ©æ‰‹è®¾ç½®</span>
                        <span style="cursor:pointer" id="btn-minimize">_</span>
                    </div>
                    <div class="panel-content">
                        <div class="panel-row">
                            <label><input type="checkbox" id="cb-translate" ${isTranslationEnabled?'checked':''}> å¯ç”¨ç¿»è¯‘</label>
                        </div>
                        <div class="panel-row">
                            <label><input type="checkbox" id="cb-btn-adapt" ${BUTTON_ADAPTER_CONFIG.isEnabled?'checked':''}> æŒ‰é’®é«˜åº¦é€‚é…</label>
                        </div>
                        <div class="panel-row">
                            <span>æœ€å°å­—ä½“:</span>
                            <input type="number" id="inp-min-font" value="${MIN_FONT_SIZE}" min="10" max="20">
                        </div>
                        <div class="panel-row">
                            <span>æœ€å¤§å­—ä½“:</span>
                            <input type="number" id="inp-max-font" value="${MAX_FONT_SIZE}" min="14" max="40">
                        </div>
                        <div style="margin-top:8px; text-align:right; color:#999; font-size:10px;">v8.1.0 æ€§èƒ½ä¼˜åŒ–ç‰ˆ</div>
                    </div>
                `;
                
                // ç»‘å®šäº‹ä»¶
                controlPanel.querySelector('#btn-minimize').onclick = () => {
                    controlPanelMinimized = true;
                    saveSettings();
                    updateView();
                };
                controlPanel.querySelector('#cb-translate').onchange = (e) => {
                    isTranslationEnabled = e.target.checked;
                    saveSettings();
                    processAllCellsInBatches(); // é‡æ–°åº”ç”¨
                };
                controlPanel.querySelector('#cb-btn-adapt').onchange = (e) => {
                    BUTTON_ADAPTER_CONFIG.isEnabled = e.target.checked;
                    saveSettings();
                };
                controlPanel.querySelector('#inp-min-font').onchange = (e) => {
                    MIN_FONT_SIZE = Number(e.target.value);
                    saveSettings();
                };
                controlPanel.querySelector('#inp-max-font').onchange = (e) => {
                    MAX_FONT_SIZE = Number(e.target.value);
                    saveSettings();
                };
            }
        };
        
        updateView();
        document.body.appendChild(controlPanel);
    }

    init();
})();
